name: Build QTBase for Linux
  
agent:
  type: Unity::VM
  image: desktop/qt-linux-build-image:latest
  flavor: b1.xlarge

artifacts:
  qtbase-linux.zip:
    paths:
      - build/builds.7z

commands:
  - sudo sed -i -- 's/#deb-src/deb-src/g' /etc/apt/sources.list && sudo sed -i -- 's/# deb-src/deb-src/g' /etc/apt/sources.list
  - echo "Allowed source repositories"
  - sudo apt-get -y update
  - sudo DEBIAN_FRONTEND=noninteractive apt-get -y build-dep qt5-default
  - sudo DEBIAN_FRONTEND=noninteractive apt-get -y install libxcb-xinerama0-dev
  - sudo DEBIAN_FRONTEND=noninteractive apt-get -y install '^libxcb.*-dev' libx11-xcb-dev libglu1-mesa-dev libxrender-dev libxi-dev
  - git clone https://github.com/openssl/openssl
  - git -C /home/bokken/build/output/Unity-Technologies/qtbase/openssl checkout -b 1.0.2 origin/OpenSSL_1_0_2-stable
  - sudo mount --bind /dev /toolchains/linux/dev
  - mkdir /toolchains/linux/qtbase
  - sudo mount --bind /home/bokken/build/output/Unity-Technologies/qtbase /toolchains/linux/qtbase
  - sudo chroot --userspec=bokken:bokken /toolchains/linux sh -c "cd /qtbase ; perl build.pl --arch=64"

triggers:
  pushes:
    only:
      - qtbuild.5.13.2
      - qtbuild.5.13.2-linux
